The book opens with an encounter near the Spanish Portuguese border between Sharpe and his company and a group of French soldiers in grey uniforms, caught in the act of raping a young Spanish villager. Their leader, Brigadier-General Guy Loup arranges a parlay to retrieve his men, but Sharpe, appalled by the rape and massacre of all the other villagers, including children, orders the French prisoners shot. Loup swears revenge against Sharpe. Back at headquarters, Sharpe is informed by Major Michael Hogan that the Real Compania Irlandesa, the royal bodyguard of the captive King of Spain have escaped from Madrid to enlist with the native Spanish armies. As the British wish for Wellesley to be made Generalissimo of the Spanish Armies, it is imperative that the Compania be treated with honour, but as the Royal Guard are drawn entirely from Irish exiles bitterly opposed to the British occupation of their homeland, they pose a risk to the security of the British army. Sharpe is ordered to take them to a far away fort and drill them mercilessly in order to encourage desertion, while the Wagon Master-General Colonel Claude Runciman, a monstrously fat and idolent man, is appointed to soothe the pride of the Compania's Spanish and Irish officers. Unfortunately Pierre Ducos, a French intelligence officer, has placed an agent within the Compania Irlandesa, Dona Juanita de Elia, a Spanish noblewoman, the mistress both of the Compania's commander, Lord Kiely, and of Loup. Rumours of British atrocities in Ireland, backed up by forged American newspapers, seem to ensure the Compania will desert, as planned, but Sharpe finds it hard to resist his instincts to turn the demoralised exiles into real soldiers. He persuades Runciman to divert arms and ammunition to the Compania, and conspires with a local partisan, El Castrador, to kill and mutilate a party of deserters to deter the rest. The Compania are joined at the fort by a Portuguese infantry battalion. Sharpe, concerned by the threat posed by Loup's personal vendetta against him, is forced to confess to the illegal execution of Loup's men. That night, Loup attacks the fort, massacres the Portuguese, and is only driven off by the explosion of the ammunition wagons, set alight by Sharpe's friend, Tom Garrard who sacrifices himself in the process.. Sharpe's earlier confession and the imminent enquiry into the disaster threaten to end Sharpe's career. To avoid this, Sharpe attacks Loup's hideout but finds it deserted, except for the Dona Juanita, who is exposed as the enemy agent, and courier of the forged newspapers. Sharpe sleeps with Juanita, and lets her go the following morning, thus frustrating Hogan's hopes of uncovering her accomplice in the Compania. The disgraced Kiely commits suicide, and his funeral is presided over by the Regiment's chaplain, Father Sarsfield. In a private conversation over the open grave, Hogan informs Sarsfield that he is aware of his treachery, but lacks proof. Sarsfield attempts to kill Hogan, but is shot by Sharpe, and buried with Kiely. The French, led by Marshal André Masséna, prepare to draw Wellington into battle and cut the British off from their only route of retreat. Wellington concentrates his forces on the village of Fuentes de Onoro. Still in disgrace, Sharpe, Runciman and the Real Compania Irlandese are left guarding the ammunition wagons. Concentrated French assaults push the British out of the village and back steadily up the hill. Wellington releases his reserves, the 74th, 45th and the 88th Connaught Rangers, who beat back the French into the village. However, the British are in turn counter-attacked by the Loup Brigade. With Sharpe's encouragement, Runciman "offers" to lead the Spanish Regiment to reinforce the Highlanders and Connaught Rangers. They are successful, and as the Loup Brigade falters the French fall back, and Wellington sends the line forward, winning the battle. Loup and Sharpe duel in the ford over the river. At a crucial moment in the fight, Sharpe is shot and wounded by the Dona Juanita, who is in turn killed by Harper. Despite his wound, Sharpe disarms and drowns Loup. The Real Compania Irlandese are sent to the Spanish Junta in Cadiz with honour and Wellington becomes Generalissimo of the Spanish armies. The case against Sharpe and Runciman is dropped, in light of their bravery, and lack of evidence.